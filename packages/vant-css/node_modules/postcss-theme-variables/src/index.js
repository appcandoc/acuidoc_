const postcss = require('postcss');
const startsWith = require('lodash/startsWith');
const has = require('lodash/has');

module.exports = postcss.plugin('postcss-theme-variables', options => {
  options = options || {};
  const vars = options.vars || {};
  const prefix = options.prefix || '';

  return css => {
    css.walkDecls(decl => {
      const { prop } = decl;

      if (!startsWith(prop, prefix)) {
        return;
      }

      const symbol = prop.slice(prefix.length);

      // Support both `var` and `${prefix}var` in options.vars
      if (has(vars, symbol)) {
        decl.value = vars[symbol];
      } else if (prefix && has(vars, prop)) {
        decl.value = vars[prop];
      }
    });
  };
});
